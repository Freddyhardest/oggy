<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Javascript: matrix generator (Source Viewer)</title>
    <style>
        /* Speed-optimized CSS with minimal reflows */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .viewer-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .controls {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .btn.success {
            background: #28a745;
        }

        .btn.success:hover {
            background: #218838;
        }

        .status {
            flex: 1;
            text-align: center;
            font-weight: 500;
        }

        .status.loading {
            color: #007bff;
        }

        .status.error {
            color: #dc3545;
        }

        .status.success {
            color: #28a745;
        }

        .url-display {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            font-size: 14px;
        }

        /* MODIFIED: Replaced iframe with a source code viewer */
        .source-container {
            position: relative;
            height: 600px;
            background: #f8f9fa;
            overflow: auto;
        }

        .source-content {
            width: 100%;
            height: 100%;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            background: white;
            overflow: auto;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #007bff;
            z-index: 10;
        }

        .stats {
            background: #f8f9fa;
            padding: 15px 20px;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #6c757d;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Fractal containment styling */
        .fractal-component {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin: 10px 0;
            padding: 15px;
            background: white;
        }

        .fractal-header {
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .btn {
                width: 100%;
            }

            .stats {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Javascript: matrix generator (Source Viewer)</h1>
        </div>

        <div class="viewer-container">
            <!-- Fractal Component: Controls -->
            <div class="fractal-component">
                <div class="fractal-header">Navigation Controls</div>
                <div class="controls">
                    <button class="btn" id="prevBtn">← Previous</button>
                    <button class="btn" id="nextBtn">Next →</button>
                    <button class="btn" id="playBtn">▶ Auto Play</button>
                    <button class="btn success" id="reloadBtn">↻ Reload</button>
                    <div class="status" id="status">Ready</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <!-- Fractal Component: URL Display -->
            <div class="fractal-component">
                <div class="fractal-header">Current URL</div>
                <div class="url-display" id="urlDisplay">https://0-1.one</div>
            </div>

            <!-- MODIFIED: Fractal Component: Source Code Viewer -->
            <div class="fractal-component">
                <div class="fractal-header">Source Code Viewer</div>
                <div class="source-container">
                    <div class="loading-overlay" id="loadingOverlay">Loading...</div>
                    <pre class="source-content" id="sourceContent"></pre>
                </div>
            </div>

            <!-- Fractal Component: Statistics -->
            <div class="fractal-component">
                <div class="fractal-header">Statistics</div>
                <div class="stats">
                    <span id="currentIndex">URL 1 of 699,724</span>
                    <span id="loadTime">Load Time: 0ms</span>
                    <span id="successRate">Success Rate: 0%</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Speed-optimized JavaScript with strict mode
        'use strict';

        // Fractal containment - Main viewer component
        class SequentialURLViewer {
            constructor() {
                // Cache DOM elements for speed
                this.cacheElements();

                // State management
                this.urls = [];
                this.currentIndex = 0;
                this.isPlaying = false;
                this.playInterval = null;
                this.successCount = 0;
                this.loadStartTime = 0;
                this.abortController = null; // For cancelling slow requests

                // Performance optimization
                this.debounceTimer = null;
                this.cache = new Map();

                // Initialize
                this.init();
            }

            cacheElements() {
                // Cache all DOM references to minimize DOM queries
                this.elements = {
                    prevBtn: document.getElementById('prevBtn'),
                    nextBtn: document.getElementById('nextBtn'),
                    playBtn: document.getElementById('playBtn'),
                    reloadBtn: document.getElementById('reloadBtn'),
                    status: document.getElementById('status'),
                    urlDisplay: document.getElementById('urlDisplay'),
                    // MODIFIED: Replaced iframe with source content
                    sourceContent: document.getElementById('sourceContent'),
                    loadingOverlay: document.getElementById('loadingOverlay'),
                    progressFill: document.getElementById('progressFill'),
                    currentIndex: document.getElementById('currentIndex'),
                    loadTime: document.getElementById('loadTime'),
                    successRate: document.getElementById('successRate')
                };
            }

            async init() {
                this.updateStatus('Initializing...', 'loading');

                try {
                    // Load URLs from the text file
                    await this.loadURLs();
                    this.setupEventListeners();
                    this.loadCurrentURL();
                    this.updateStatus('Ready', 'success');
                } catch (error) {
                    this.updateStatus('Initialization failed', 'error');
                    console.error('Initialization error:', error);
                }
            }

            async loadURLs() {
                try {
                    // Fetch the URLs from the text file
                    const response = await fetch('https://raw.githubusercontent.com/cenk/nrd/refs/heads/main/nrd-last-10-days.txt');
                    const text = await response.text();

                    // Parse URLs (skip comment lines starting with #)
                    this.urls = text.split('\n')
                        .filter(line => line.trim() && !line.startsWith('#'))
                        .map(line => line.trim())
                        .filter(line => line.includes('.')); // Ensure it's a valid domain

                    console.log(`Loaded ${this.urls.length} URLs`);
                } catch (error) {
                    console.error('Failed to load URLs:', error);
                    // Fallback to sample URLs if fetch fails
                    this.urls = [
                        'https://0-1.one',
                        'https://0-1c.com',
                        'https://0-centra.org',
                        'https://00-00.net',
                        'https://00.law'
                    ];
                }
            }

            setupEventListeners() {
                // Event delegation for better performance
                this.elements.prevBtn.addEventListener('click', () => this.previousURL());
                this.elements.nextBtn.addEventListener('click', () => this.nextURL());
                this.elements.playBtn.addEventListener('click', () => this.toggleAutoPlay());
                this.elements.reloadBtn.addEventListener('click', () => this.reloadCurrentURL());

                // Keyboard shortcuts for speed
                document.addEventListener('keydown', (e) => {
                    switch(e.key) {
                        case 'ArrowLeft':
                            this.previousURL();
                            break;
                        case 'ArrowRight':
                        case ' ':
                            e.preventDefault();
                            this.nextURL();
                            break;
                        case 'Enter':
                            this.toggleAutoPlay();
                            break;
                    }
                });
            }

            // MODIFIED: This function now fetches source code via your Render backend
            async loadCurrentURL() {
                if (this.urls.length === 0) return;

                // Cancel any previous request
                if (this.abortController) {
                    this.abortController.abort();
                }

                const url = this.urls[this.currentIndex];
                const fullURL = url.startsWith('http') ? url : `https://${url}`;

                this.elements.urlDisplay.textContent = fullURL;
                this.elements.loadingOverlay.style.display = 'flex';
                this.loadStartTime = performance.now();

                // Create a new AbortController for this request
                this.abortController = new AbortController();

                try {
                    this.updateStatus('Fetching source...', 'loading');

                    // Send request to your Render backend with a 10-second timeout
                    const proxyResponse = await fetch(`https://queer.onrender.com/code.py?url=${encodeURIComponent(fullURL)}`, {
                        signal: this.abortController.signal
                    });

                    const data = await proxyResponse.json();

                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // Display the raw HTML source code
                    this.elements.sourceContent.textContent = data.html;
                    this.onURLLoad(data.size);

                } catch (error) {
                    // Check if the error is due to an abort (timeout or user action)
                    if (error.name === 'AbortError') {
                        this.onURLError('Request timed out');
                    } else {
                        this.onURLError(error.message);
                    }
                }

                // CRITICAL FIX: Update the UI to reflect the current index
                this.updateUI();
            }

            onURLLoad(size) {
                const loadTime = Math.round(performance.now() - this.loadStartTime);
                this.elements.loadingOverlay.style.display = 'none';
                this.elements.loadTime.textContent = `Size: ${size} | Time: ${loadTime}ms`;
                this.updateStatus('Loaded successfully', 'success');
                this.successCount++;
                this.updateStats();
            }

            onURLError(errorMessage) {
                this.elements.loadingOverlay.style.display = 'none';
                this.elements.sourceContent.textContent = `Error: ${errorMessage}`;
                this.updateStatus('Failed to load source', 'error');
                this.updateStats();

                // Auto-skip to next URL after a VERY short delay (optimized for speed)
                if (this.isPlaying) {
                    setTimeout(() => {
                        this.nextURL();
                    }, 500); // Reduced from 2000ms to 500ms
                }
            }

            previousURL() {
                if (this.currentIndex > 0) {
                    this.currentIndex--;
                    this.loadCurrentURL();
                }
            }

            nextURL() {
                if (this.currentIndex < this.urls.length - 1) {
                    this.currentIndex++;
                    this.loadCurrentURL();
                } else {
                    this.updateStatus('End of URLs', 'error');
                    this.stopAutoPlay();
                }
            }

            reloadCurrentURL() {
                this.loadCurrentURL();
            }

            toggleAutoPlay() {
                if (this.isPlaying) {
                    this.stopAutoPlay();
                } else {
                    this.startAutoPlay();
                }
            }

            startAutoPlay() {
                this.isPlaying = true;
                this.elements.playBtn.textContent = '⏸ Pause';
                this.playInterval = setInterval(() => {
                    this.nextURL();
                }, 5000); // 5 second intervals
            }

            stopAutoPlay() {
                this.isPlaying = false;
                this.elements.playBtn.textContent = '▶ Auto Play';
                if (this.playInterval) {
                    clearInterval(this.playInterval);
                    this.playInterval = null;
                }
            }

            updateStatus(message, type = '') {
                this.elements.status.textContent = message;
                this.elements.status.className = `status ${type}`;
            }

            updateUI() {
                // Update progress bar
                const progress = ((this.currentIndex + 1) / this.urls.length) * 100;
                this.elements.progressFill.style.width = `${progress}%`;

                // Update current index display
                this.elements.currentIndex.textContent = `URL ${this.currentIndex + 1} of ${this.urls.length}`;

                // Update button states
                this.elements.prevBtn.disabled = this.currentIndex === 0;
                this.elements.nextBtn.disabled = this.currentIndex === this.urls.length - 1;
            }

            updateStats() {
                const successRate = this.urls.length > 0 ?
                    Math.round((this.successCount / (this.currentIndex + 1)) * 100) : 0;
                this.elements.successRate.textContent = `Success Rate: ${successRate}%`;
            }
        }

        // Speed optimization: Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                new SequentialURLViewer();
            });
        } else {
            new SequentialURLViewer();
        }

        // Memory management
        window.addEventListener('beforeunload', () => {
            // Clean up intervals and event listeners
            if (window.viewer && window.viewer.playInterval) {
                clearInterval(window.viewer.playInterval);
            }
        });
    </script>
</body>
</html>
